<img src="https://cdn.prod.website-files.com/677c400686e724409a5a7409/6790ad949cf622dc8dcd9fe4_nextwork-logo-leather.svg" alt="NextWork" width="300" />

# VPC Monitoring with Flow Logs

**Project Link:** [View Project](http://learn.nextwork.org/projects/aws-networks-monitoring)

**Author:** Usman Tanvir  
**Email:** usmantanvir@gmail.com

---

## VPC Monitoring with Flow Logs

![Image](http://learn.nextwork.org/restful_green_glamorous_manatee/uploads/aws-networks-monitoring_3e1e79a1)

---

## Introducing Today's Project!

### What is Amazon VPC?

Amazon VPC is a is a logically isolated section of the AWS Cloud where you can run and manage resources in a virtual network that you fully control. It is useful as it allows users to have their own infrastructure private from other users.

### How I used Amazon VPC in this project

I used Amazon VPC to define two VPC's and then connect then by enabling VPC Peering between them. I also created VPC Flow logs to analyze the logs and monitor flow logs and then used Logs Insights to run queries.

### One thing I didn't expect in this project was...

I had a little trouble getting Flow logs to work which I was able to debug and figure out that the Role I created had a policy missing.

### This project took me...

This project took me about 1.5 hours including demo time and documentation.

---

## In the first part of my project...

### Step 1 - Set up VPCs

I first created my 2 VPC's with all its components with the VPC resource map which is a very helpful option to quickly configure VPC's.

### Step 2 - Launch EC2 instances

In this step I launched an EC2 instance in each VPC, so I could use them to test my VPC peering connection later.

### Step 3 - Set up Logs

In this step I set up VPC flow logs to start monitoring all inbound and outbound network traffic and set up a space that stores all these records.

### Step 4 - Set IAM permissions for Logs

In this step I provided VPC Flow Logs with permission to create logs and upload them into the Log Group in CloudWatch.

---

## Multi-VPC Architecture

I started my project by launching the 'VPC and more' option to create a new VPC. I created 1 subnet for both VPC's that I have set public.

The CIDR blocks for my two VPCs are 10.1.0.0/16 for VPC 1 and 10.2.0.0/16 for VPC 2. Itʼs important that these CIDR blocks are unique because when using VPC peering to enable communication between the two VPCs, their IP address ranges must not overlap. Unique IP ranges ensure that traffic is routed correctly without conflicts.

### I also launched EC2 instances in each subnet

My EC2 instances's security groups allow SSH traffic from port 22 and all ICMP traffic. This is because I want to be able to use EC2 Instance Connect and then use ping to check connectivity between my 2 VPC's.

![Image](http://learn.nextwork.org/restful_green_glamorous_manatee/uploads/aws-networks-monitoring_e7fa8775)

---

## Logs

Logs are records of events and activities generated by software, systems, or devices. In the context of VPC logs help you monitor, troubleshoot, and audit what's happening in your environment.

Log groups are like folders in Amazon CloudWatch Logs that organize and store logs from related resources. Each log group contains log streams, which are sequences of log events from a specific resource, such as an EC2 instance or Lambda function. Logs generated by the same resource or application are typically saved within the same log group, making it easier to manage, monitor, and analyze log data for that resource.

### I also set up a flow log for VPC 1

![Image](http://learn.nextwork.org/restful_green_glamorous_manatee/uploads/aws-networks-monitoring_e8398869)

---

## IAM Policy and Roles

I created an IAM policy to define permissions that allow services like VPC Flow Logs to create log streams and upload log data to Amazon CloudWatch Logs. This policy grants the necessary access for the flow logs service to deliver logs to a specific log group, ensuring that network traffic data is captured and stored for monitoring and analysis.

I also created an IAM role because services like VPC Flow Logs require a role to assume, rather than just attaching a standalone policy in JSON format. Creating an IAM role is necessary to grant VPC Flow Logs the appropriate permissions to record network traffic and upload logs to CloudWatch. 

The role includes a trust policy that allows the VPC Flow Logs service to assume the role, and an inline or attached permissions policy that defines the specific actions it can perform.

![Image](http://learn.nextwork.org/restful_green_glamorous_manatee/uploads/aws-networks-monitoring_4334d777)

---

## In the second part of my project...

### Step 5 - Ping testing and troubleshooting

In this step I generated traffic from an instance in VPC 1 to another instance in VPC 2 to make sure VPC peering was working between these two VPC's.

### Step 6 - Set up a peering connection

In this step I created a VPC Peering connection between VPC 1 and VPC 2 so they can communicate with each other.

### Step 7 - Analyze flow logs

In this step, I reviewed the flow logs recorded for VPC 1’s public subnet and analyzed the log entries to gain insights into the network traffic. This helped me verify that traffic was flowing as expected and identify any unusual patterns or potential connectivity issues.

---

## Connectivity troubleshooting

My first ping test between my EC2 isntances had no replies which meant there was no route between them.

![Image](http://learn.nextwork.org/restful_green_glamorous_manatee/uploads/aws-networks-monitoring_99d4ba42)

I could receive ping replies if I ran the ping test using the other instance's public IP address which meant that both allowed ICMP traffic and had a route using the Public Internet.

---

## Connectivity troubleshooting

Looking at VPC 1's route table I identified that ping test with Instance 2's private address failed because there was no route which directs traffic from one VPC to the other.

### To solve this, I set up a peering connection between my VPCs

I also updated the route tables in both VPCs to ensure that each VPC could send and receive traffic from the other through the established VPC Peering Connection. This bidirectional routing is necessary for successful communication between resources in different VPCs using their private IP addresses.

![Image](http://learn.nextwork.org/restful_green_glamorous_manatee/uploads/aws-networks-monitoring_7316a13d)

---

## Connectivity troubleshooting

I received ping replies from Instance 2's private IP address! This meant that the VPC Peering connection works successfully. 

![Image](http://learn.nextwork.org/restful_green_glamorous_manatee/uploads/aws-networks-monitoring_4ec7821f)

---

## Analyzing flow logs

Flow logs provide detailed information about network traffic in your VPC. They record key details such as the source and destination IP addresses, ports, protocol, the amount of data transferred, and whether the traffic was accepted or rejected based on your security group and network ACL rules. This data is essential for monitoring, troubleshooting, and securing network communications within your AWS environment.

For example the flow the logs I caputured tells us that traffic went from 10.1.13.238 to 10.2.3.179. We can also see that the traffic was accepted by the security groups and Network ACL's of my VPC.

![Image](http://learn.nextwork.org/restful_green_glamorous_manatee/uploads/aws-networks-monitoring_d116818e)

---

## Logs Insights

Logs Insights is a CloudWatch feature that analyzes your logs. In Log Insights, you use queries to filter, process and combine data to help you troubleshoot problems or better understand your network traffic!

I ran the query 'Return the top 10 byte transfers by source and destination IP addresses'. This query analyzes the flow logs collected on EC2 Instance 1 and it will return the top 10 pairs of IP addresses based on the amount of data transferred between them.

![Image](http://learn.nextwork.org/restful_green_glamorous_manatee/uploads/aws-networks-monitoring_3e1e79a1)

---

---
